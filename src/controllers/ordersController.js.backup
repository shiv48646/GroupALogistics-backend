const Order = require('../models/Order');
const Customer = require('../models/Customer');
const { sendEmail, emailTemplates } = require('../utils/email');
const { notifyUser, notificationTypes } = require('../utils/notifications');

// Get all orders
exports.getAllOrders = async (req, res) => {
  try {
    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 10;
    const skip = (page - 1) * limit;

    const orders = await Order.find()
      .populate('customer', 'name email phone')
      .populate('createdBy', 'name email')
      .sort({ createdAt: -1 })
      .skip(skip)
      .limit(limit);

    const total = await Order.countDocuments();

    res.status(200).json({
      success: true,
      data: {
        orders,
        pagination: {
          page,
          limit,
          total,
          pages: Math.ceil(total / limit)
        }
      }
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Error fetching orders',
      error: error.message
    });
  }
};

// Get single order
exports.getOrderById = async (req, res) => {
  try {
    const order = await Order.findById(req.params.id)
      .populate('customer')
      .populate('createdBy', 'name email');

    if (!order) {
      return res.status(404).json({
        success: false,
        message: 'Order not found'
      });
    }

    res.status(200).json({
      success: true,
      data: order
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Error fetching order',
      error: error.message
    });
  }
};

// Create order with email notification
exports.createOrder = async (req, res) => {
  try {
    const orderData = {
      ...req.body,
      createdBy: req.user.id
    };

    const order = await Order.create(orderData);
    const populatedOrder = await Order.findById(order._id)
      .populate('customer')
      .populate('createdBy');

    // Send email notification
    if (populatedOrder.customer && populatedOrder.customer.email) {
      const emailData = emailTemplates.orderConfirmation(
        populatedOrder,
        populatedOrder.customer
      );
      await sendEmail({
        to: populatedOrder.customer.email,
        ...emailData
      });
    }

    // Send in-app notification
    await notifyUser(
      req.user.id,
      notificationTypes.ORDER_CREATED,
      'Order Created',
      `Order ${order.orderNumber} has been created successfully`,
      { orderId: order._id }
    );

    res.status(201).json({
      success: true,
      message: 'Order created successfully',
      data: populatedOrder
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Error creating order',
      error: error.message
    });
  }
};

// Update order with notification
exports.updateOrder = async (req, res) => {
  try {
    const order = await Order.findByIdAndUpdate(
      req.params.id,
      req.body,
      { new: true, runValidators: true }
    ).populate('customer');

    if (!order) {
      return res.status(404).json({
        success: false,
        message: 'Order not found'
      });
    }

    // Notify about status change
    if (req.body.status) {
      await notifyUser(
        order.createdBy,
        notificationTypes.ORDER_UPDATED,
        'Order Updated',
        `Order ${order.orderNumber} status changed to ${req.body.status}`,
        { orderId: order._id, status: req.body.status }
      );
    }

    res.status(200).json({
      success: true,
      message: 'Order updated successfully',
      data: order
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Error updating order',
      error: error.message
    });
  }
};

// Delete order
exports.deleteOrder = async (req, res) => {
  try {
    const order = await Order.findByIdAndDelete(req.params.id);

    if (!order) {
      return res.status(404).json({
        success: false,
        message: 'Order not found'
      });
    }

    res.status(200).json({
      success: true,
      message: 'Order deleted successfully'
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Error deleting order',
      error: error.message
    });
  }
};

// Get order statistics
exports.getOrderStats = async (req, res) => {
  try {
    const stats = await Order.aggregate([
      {
        $group: {
          _id: '$status',
          count: { $sum: 1 },
          totalAmount: { $sum: '$totalAmount' }
        }
      }
    ]);

    res.status(200).json({
      success: true,
      data: stats
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Error fetching statistics',
      error: error.message
    });
  }
};

module.exports = exports;
